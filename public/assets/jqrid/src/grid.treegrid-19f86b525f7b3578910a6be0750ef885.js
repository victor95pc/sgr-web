!function(e){"use strict";e.jgrid.extend({setTreeNode:function(r,t){return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid)for(var d,a,s,n,l,p,o,c,h=i.p.expColInd,f=i.p.treeReader.expanded_field,u=i.p.treeReader.leaf_field,g=i.p.treeReader.level_field,v=i.p.treeReader.icon_field,_=i.p.treeReader.loaded;t>r;){var G,R=e.jgrid.stripPref(i.p.idPrefix,i.rows[r].id),j=i.p._index[R];if(o=i.p.data[j],"nested"===i.p.treeGridModel&&(o[u]||(d=parseInt(o[i.p.treeReader.left_field],10),a=parseInt(o[i.p.treeReader.right_field],10),o[u]=a===d+1?"true":"false",i.rows[r].cells[i.p._treeleafpos].innerHTML=o[u])),s=parseInt(o[g],10),0===i.p.tree_root_level?(n=s+1,l=s):(n=s,l=s-1),p="<div class='tree-wrap tree-wrap-"+i.p.direction+"' style='width:"+18*n+"px;'>",p+="<div style='"+("rtl"===i.p.direction?"right:":"left:")+18*l+"px;' class='ui-icon ",void 0!==o[_]&&(o[_]="true"===o[_]||o[_]===!0?!0:!1),"true"===o[u]||o[u]===!0?(p+=(void 0!==o[v]&&""!==o[v]?o[v]:i.p.treeIcons.leaf)+" tree-leaf treeclick",o[u]=!0,c="leaf"):(o[u]=!1,c=""),o[f]=("true"===o[f]||o[f]===!0?!0:!1)&&(o[_]||void 0===o[_]),p+=o[f]===!1?o[u]===!0?"'":i.p.treeIcons.plus+" tree-plus treeclick'":o[u]===!0?"'":i.p.treeIcons.minus+" tree-minus treeclick'",p+="></div></div>",e(i.rows[r].cells[h]).wrapInner("<span class='cell-wrapper"+c+"'></span>").prepend(p),s!==parseInt(i.p.tree_root_level,10)){var I=e(i).jqGrid("getNodeParent",o);G=I&&I.hasOwnProperty(f)?I[f]:!0,G||e(i.rows[r]).css("display","none")}e(i.rows[r].cells[h]).find("div.treeclick").bind("click",function(r){var t=r.target||r.srcElement,d=e.jgrid.stripPref(i.p.idPrefix,e(t,i.rows).closest("tr.jqgrow")[0].id),a=i.p._index[d];return i.p.data[a][u]||(i.p.data[a][f]?(e(i).jqGrid("collapseRow",i.p.data[a]),e(i).jqGrid("collapseNode",i.p.data[a])):(e(i).jqGrid("expandRow",i.p.data[a]),e(i).jqGrid("expandNode",i.p.data[a]))),!1}),i.p.ExpandColClick===!0&&e(i.rows[r].cells[h]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(r){var t=r.target||r.srcElement,d=e.jgrid.stripPref(i.p.idPrefix,e(t,i.rows).closest("tr.jqgrow")[0].id),a=i.p._index[d];return i.p.data[a][u]||(i.p.data[a][f]?(e(i).jqGrid("collapseRow",i.p.data[a]),e(i).jqGrid("collapseNode",i.p.data[a])):(e(i).jqGrid("expandRow",i.p.data[a]),e(i).jqGrid("expandNode",i.p.data[a]))),e(i).jqGrid("setSelection",d),!1}),r++}})},setTreeGrid:function(){return this.each(function(){var r,t,i,d,a=this,s=0,n=!1,l=[];if(a.p.treeGrid){a.p.treedatatype||e.extend(a.p,{treedatatype:a.p.datatype}),a.p.subGrid=!1,a.p.altRows=!1,a.p.pgbuttons=!1,a.p.pginput=!1,a.p.gridview=!0,null===a.p.rowTotal&&(a.p.rowNum=1e4),a.p.multiselect=!1,a.p.rowList=[],a.p.expColInd=0,r="ui-icon-triangle-1-"+("rtl"===a.p.direction?"w":"e"),a.p.treeIcons=e.extend({plus:r,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},a.p.treeIcons||{}),"nested"===a.p.treeGridModel?a.p.treeReader=e.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},a.p.treeReader):"adjacency"===a.p.treeGridModel&&(a.p.treeReader=e.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},a.p.treeReader));for(i in a.p.colModel)if(a.p.colModel.hasOwnProperty(i)){t=a.p.colModel[i].name,t!==a.p.ExpandColumn||n||(n=!0,a.p.expColInd=s),s++;for(d in a.p.treeReader)a.p.treeReader.hasOwnProperty(d)&&a.p.treeReader[d]===t&&l.push(t)}e.each(a.p.treeReader,function(r,t){t&&-1===e.inArray(t,l)&&("leaf_field"===r&&(a.p._treeleafpos=s),s++,a.p.colNames.push(t),a.p.colModel.push({name:t,width:1,hidden:!0,sortable:!1,resizable:!1,hidedlg:!0,editable:!0,search:!1}))})}})},expandRow:function(r){this.each(function(){var t=this;if(t.grid&&t.p.treeGrid){var i=e(t).jqGrid("getNodeChildren",r),d=t.p.treeReader.expanded_field,a=t.rows;e(i).each(function(){var r=t.p.idPrefix+e.jgrid.getAccessor(this,t.p.localReader.id);e(a.namedItem(r)).css("display",""),this[d]&&e(t).jqGrid("expandRow",this)})}})},collapseRow:function(r){this.each(function(){var t=this;if(t.grid&&t.p.treeGrid){var i=e(t).jqGrid("getNodeChildren",r),d=t.p.treeReader.expanded_field,a=t.rows;e(i).each(function(){var r=t.p.idPrefix+e.jgrid.getAccessor(this,t.p.localReader.id);e(a.namedItem(r)).css("display","none"),this[d]&&e(t).jqGrid("collapseRow",this)})}})},getRootNodes:function(){var r=[];return this.each(function(){var t=this;if(t.grid&&t.p.treeGrid)switch(t.p.treeGridModel){case"nested":var i=t.p.treeReader.level_field;e(t.p.data).each(function(){parseInt(this[i],10)===parseInt(t.p.tree_root_level,10)&&r.push(this)});break;case"adjacency":var d=t.p.treeReader.parent_id_field;e(t.p.data).each(function(){(null===this[d]||"null"===String(this[d]).toLowerCase())&&r.push(this)})}}),r},getNodeDepth:function(r){var t=null;return this.each(function(){if(this.grid&&this.p.treeGrid){var i=this;switch(i.p.treeGridModel){case"nested":var d=i.p.treeReader.level_field;t=parseInt(r[d],10)-parseInt(i.p.tree_root_level,10);break;case"adjacency":t=e(i).jqGrid("getNodeAncestors",r).length}}}),t},getNodeParent:function(r){var t=null;return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid)switch(i.p.treeGridModel){case"nested":var d=i.p.treeReader.left_field,a=i.p.treeReader.right_field,s=i.p.treeReader.level_field,n=parseInt(r[d],10),l=parseInt(r[a],10),p=parseInt(r[s],10);e(this.p.data).each(function(){return parseInt(this[s],10)===p-1&&parseInt(this[d],10)<n&&parseInt(this[a],10)>l?(t=this,!1):void 0});break;case"adjacency":var o=i.p.treeReader.parent_id_field,c=i.p.localReader.id;e(this.p.data).each(function(){return this[c]===e.jgrid.stripPref(i.p.idPrefix,r[o])?(t=this,!1):void 0})}}),t},getNodeChildren:function(r){var t=[];return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid)switch(i.p.treeGridModel){case"nested":var d=i.p.treeReader.left_field,a=i.p.treeReader.right_field,s=i.p.treeReader.level_field,n=parseInt(r[d],10),l=parseInt(r[a],10),p=parseInt(r[s],10);e(this.p.data).each(function(){parseInt(this[s],10)===p+1&&parseInt(this[d],10)>n&&parseInt(this[a],10)<l&&t.push(this)});break;case"adjacency":var o=i.p.treeReader.parent_id_field,c=i.p.localReader.id;e(this.p.data).each(function(){this[o]==e.jgrid.stripPref(i.p.idPrefix,r[c])&&t.push(this)})}}),t},getFullTreeNode:function(r){var t=[];return this.each(function(){var i,d=this;if(d.grid&&d.p.treeGrid)switch(d.p.treeGridModel){case"nested":var a=d.p.treeReader.left_field,s=d.p.treeReader.right_field,n=d.p.treeReader.level_field,l=parseInt(r[a],10),p=parseInt(r[s],10),o=parseInt(r[n],10);e(this.p.data).each(function(){parseInt(this[n],10)>=o&&parseInt(this[a],10)>=l&&parseInt(this[a],10)<=p&&t.push(this)});break;case"adjacency":if(r){t.push(r);var c=d.p.treeReader.parent_id_field,h=d.p.localReader.id;e(this.p.data).each(function(r){for(i=t.length,r=0;i>r;r++)if(e.jgrid.stripPref(d.p.idPrefix,t[r][h])===this[c]){t.push(this);break}})}}}),t},getNodeAncestors:function(r){var t=[];return this.each(function(){if(this.grid&&this.p.treeGrid)for(var i=e(this).jqGrid("getNodeParent",r);i;)t.push(i),i=e(this).jqGrid("getNodeParent",i)}),t},isVisibleNode:function(r){var t=!0;return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid){var d=e(i).jqGrid("getNodeAncestors",r),a=i.p.treeReader.expanded_field;e(d).each(function(){return t=t&&this[a],t?void 0:!1})}}),t},isNodeLoaded:function(r){var t;return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid){var d=i.p.treeReader.leaf_field;t=void 0!==r?void 0!==r.loaded?r.loaded:r[d]||e(i).jqGrid("getNodeChildren",r).length>0?!0:!1:!1}}),t},expandNode:function(r){return this.each(function(){if(this.grid&&this.p.treeGrid){var t=this.p.treeReader.expanded_field,i=this.p.treeReader.parent_id_field,d=this.p.treeReader.loaded,a=this.p.treeReader.level_field,s=this.p.treeReader.left_field,n=this.p.treeReader.right_field;if(!r[t]){var l=e.jgrid.getAccessor(r,this.p.localReader.id),p=e("#"+this.p.idPrefix+e.jgrid.jqID(l),this.grid.bDiv)[0],o=this.p._index[l];e(this).jqGrid("isNodeLoaded",this.p.data[o])?(r[t]=!0,e("div.treeclick",p).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")):this.grid.hDiv.loading||(r[t]=!0,e("div.treeclick",p).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus"),this.p.treeANode=p.rowIndex,this.p.datatype=this.p.treedatatype,"nested"===this.p.treeGridModel?e(this).jqGrid("setGridParam",{postData:{nodeid:l,n_left:r[s],n_right:r[n],n_level:r[a]}}):e(this).jqGrid("setGridParam",{postData:{nodeid:l,parentid:r[i],n_level:r[a]}}),e(this).trigger("reloadGrid"),r[d]=!0,"nested"===this.p.treeGridModel?e(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}}):e(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}}))}}})},collapseNode:function(r){return this.each(function(){if(this.grid&&this.p.treeGrid){var t=this.p.treeReader.expanded_field;if(r[t]){r[t]=!1;var i=e.jgrid.getAccessor(r,this.p.localReader.id),d=e("#"+this.p.idPrefix+e.jgrid.jqID(i),this.grid.bDiv)[0];e("div.treeclick",d).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}}})},SortTree:function(r,t,i,d){return this.each(function(){if(this.grid&&this.p.treeGrid){var a,s,n,l,p,o=[],c=this,h=e(this).jqGrid("getRootNodes");for(l=e.jgrid.from(h),l.orderBy(r,t,i,d),p=l.select(),a=0,s=p.length;s>a;a++)n=p[a],o.push(n),e(this).jqGrid("collectChildrenSortTree",o,n,r,t,i,d);e.each(o,function(r){var t=e.jgrid.getAccessor(this,c.p.localReader.id);e("#"+e.jgrid.jqID(c.p.id)+" tbody tr:eq("+r+")").after(e("tr#"+e.jgrid.jqID(t),c.grid.bDiv))}),l=null,p=null,o=null}})},collectChildrenSortTree:function(r,t,i,d,a,s){return this.each(function(){if(this.grid&&this.p.treeGrid){var n,l,p,o,c,h;for(o=e(this).jqGrid("getNodeChildren",t),c=e.jgrid.from(o),c.orderBy(i,d,a,s),h=c.select(),n=0,l=h.length;l>n;n++)p=h[n],r.push(p),e(this).jqGrid("collectChildrenSortTree",r,p,i,d,a,s)}})},setTreeRow:function(r,t){var i=!1;return this.each(function(){var d=this;d.grid&&d.p.treeGrid&&(i=e(d).jqGrid("setRowData",r,t))}),i},delTreeNode:function(r){return this.each(function(){var t,i,d,a,s,n=this,l=n.p.localReader.id,p=n.p.treeReader.left_field,o=n.p.treeReader.right_field;if(n.grid&&n.p.treeGrid){var c=n.p._index[r];if(void 0!==c){i=parseInt(n.p.data[c][o],10),d=i-parseInt(n.p.data[c][p],10)+1;var h=e(n).jqGrid("getFullTreeNode",n.p.data[c]);if(h.length>0)for(t=0;t<h.length;t++)e(n).jqGrid("delRowData",h[t][l]);if("nested"===n.p.treeGridModel){if(a=e.jgrid.from(n.p.data).greater(p,i,{stype:"integer"}).select(),a.length)for(s in a)a.hasOwnProperty(s)&&(a[s][p]=parseInt(a[s][p],10)-d);if(a=e.jgrid.from(n.p.data).greater(o,i,{stype:"integer"}).select(),a.length)for(s in a)a.hasOwnProperty(s)&&(a[s][o]=parseInt(a[s][o],10)-d)}}}})},addChildNode:function(r,t,i,d){var a=this[0];if(i){var s,n,l,p,o,c,h,f,u=a.p.treeReader.expanded_field,g=a.p.treeReader.leaf_field,v=a.p.treeReader.level_field,_=a.p.treeReader.parent_id_field,G=a.p.treeReader.left_field,R=a.p.treeReader.right_field,j=a.p.treeReader.loaded,I=0,w=t;if(void 0===d&&(d=!1),void 0===r||null===r){if(o=a.p.data.length-1,o>=0)for(;o>=0;)I=Math.max(I,parseInt(a.p.data[o][a.p.localReader.id],10)),o--;r=I+1}var x=e(a).jqGrid("getInd",t);if(h=!1,void 0===t||null===t||""===t)t=null,w=null,s="last",p=a.p.tree_root_level,o=a.p.data.length+1;else{s="after",n=a.p._index[t],l=a.p.data[n],t=l[a.p.localReader.id],p=parseInt(l[v],10)+1;var q=e(a).jqGrid("getFullTreeNode",l);q.length?(o=q[q.length-1][a.p.localReader.id],w=o,o=e(a).jqGrid("getInd",w)+1):o=e(a).jqGrid("getInd",t)+1,l[g]&&(h=!0,l[u]=!0,e(a.rows[x]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(a.p.treeIcons.leaf+" tree-leaf").addClass(a.p.treeIcons.minus+" tree-minus"),a.p.data[n][g]=!1,l[j]=!0)}if(c=o+1,void 0===i[u]&&(i[u]=!1),void 0===i[j]&&(i[j]=!1),i[v]=p,void 0===i[g]&&(i[g]=!0),"adjacency"===a.p.treeGridModel&&(i[_]=t),"nested"===a.p.treeGridModel){var m,y,N;if(null!==t){if(f=parseInt(l[R],10),m=e.jgrid.from(a.p.data),m=m.greaterOrEquals(R,f,{stype:"integer"}),y=m.select(),y.length)for(N in y)y.hasOwnProperty(N)&&(y[N][G]=y[N][G]>f?parseInt(y[N][G],10)+2:y[N][G],y[N][R]=y[N][R]>=f?parseInt(y[N][R],10)+2:y[N][R]);i[G]=f,i[R]=f+1}else{if(f=parseInt(e(a).jqGrid("getCol",R,!1,"max"),10),y=e.jgrid.from(a.p.data).greater(G,f,{stype:"integer"}).select(),y.length)for(N in y)y.hasOwnProperty(N)&&(y[N][G]=parseInt(y[N][G],10)+2);if(y=e.jgrid.from(a.p.data).greater(R,f,{stype:"integer"}).select(),y.length)for(N in y)y.hasOwnProperty(N)&&(y[N][R]=parseInt(y[N][R],10)+2);i[G]=f+1,i[R]=f+2}}(null===t||e(a).jqGrid("isNodeLoaded",l)||h)&&(e(a).jqGrid("addRowData",r,i,s,w),e(a).jqGrid("setTreeNode",o,c)),l&&!l[u]&&d&&e(a.rows[x]).find("div.treeclick").click()}}})}(jQuery);