!function(e){"use strict";e.jgrid.extend({editCell:function(i,r,t){return this.each(function(){var l,o,d,s,a=this;if(a.grid&&a.p.cellEdit===!0){if(r=parseInt(r,10),a.p.selrow=a.rows[i].id,a.p.knv||e(a).jqGrid("GridNav"),a.p.savedRow.length>0){if(t===!0&&i==a.p.iRow&&r==a.p.iCol)return;e(a).jqGrid("saveCell",a.p.savedRow[0].id,a.p.savedRow[0].ic)}else window.setTimeout(function(){e("#"+e.jgrid.jqID(a.p.knv)).attr("tabindex","-1").focus()},0);if(s=a.p.colModel[r],l=s.name,"subgrid"!==l&&"cb"!==l&&"rn"!==l){if(d=e("td:eq("+r+")",a.rows[i]),s.editable!==!0||t!==!0||d.hasClass("not-editable-cell"))parseInt(a.p.iCol,10)>=0&&parseInt(a.p.iRow,10)>=0&&(e("td:eq("+a.p.iCol+")",a.rows[a.p.iRow]).removeClass("edit-cell ui-state-highlight"),e(a.rows[a.p.iRow]).removeClass("selected-row ui-state-hover")),d.addClass("edit-cell ui-state-highlight"),e(a.rows[i]).addClass("selected-row ui-state-hover"),o=d.html().replace(/\&#160\;/gi,""),e(a).triggerHandler("jqGridSelectCell",[a.rows[i].id,l,o,i,r]),e.isFunction(a.p.onSelectCell)&&a.p.onSelectCell.call(a,a.rows[i].id,l,o,i,r);else{parseInt(a.p.iCol,10)>=0&&parseInt(a.p.iRow,10)>=0&&(e("td:eq("+a.p.iCol+")",a.rows[a.p.iRow]).removeClass("edit-cell ui-state-highlight"),e(a.rows[a.p.iRow]).removeClass("selected-row ui-state-hover")),e(d).addClass("edit-cell ui-state-highlight"),e(a.rows[i]).addClass("selected-row ui-state-hover");try{o=e.unformat.call(a,d,{rowId:a.rows[i].id,colModel:s},r)}catch(n){o=s.edittype&&"textarea"===s.edittype?e(d).text():e(d).html()}if(a.p.autoencode&&(o=e.jgrid.htmlDecode(o)),s.edittype||(s.edittype="text"),a.p.savedRow.push({id:i,ic:r,name:l,v:o}),("&nbsp;"===o||"&#160;"===o||1===o.length&&160===o.charCodeAt(0))&&(o=""),e.isFunction(a.p.formatCell)){var c=a.p.formatCell.call(a,a.rows[i].id,l,o,i,r);void 0!==c&&(o=c)}var p=e.extend({},s.editoptions||{},{id:i+"_"+l,name:l}),f=e.jgrid.createEl.call(a,s.edittype,p,o,!0,e.extend({},e.jgrid.ajaxOptions,a.p.ajaxSelectOptions||{}));e(a).triggerHandler("jqGridBeforeEditCell",[a.rows[i].id,l,o,i,r]),e.isFunction(a.p.beforeEditCell)&&a.p.beforeEditCell.call(a,a.rows[i].id,l,o,i,r),e(d).html("").append(f).attr("tabindex","0"),e.jgrid.bindEv.call(a,f,p),window.setTimeout(function(){e(f).focus()},0),e("input, select, textarea",d).bind("keydown",function(t){if(27===t.keyCode&&(e("input.hasDatepicker",d).length>0?e(".ui-datepicker").is(":hidden")?e(a).jqGrid("restoreCell",i,r):e("input.hasDatepicker",d).datepicker("hide"):e(a).jqGrid("restoreCell",i,r)),13===t.keyCode)return e(a).jqGrid("saveCell",i,r),!1;if(9===t.keyCode){if(a.grid.hDiv.loading)return!1;t.shiftKey?e(a).jqGrid("prevCell",i,r):e(a).jqGrid("nextCell",i,r)}t.stopPropagation()}),e(a).triggerHandler("jqGridAfterEditCell",[a.rows[i].id,l,o,i,r]),e.isFunction(a.p.afterEditCell)&&a.p.afterEditCell.call(a,a.rows[i].id,l,o,i,r)}a.p.iCol=r,a.p.iRow=i}}})},saveCell:function(i,r){return this.each(function(){var t,l=this;if(l.grid&&l.p.cellEdit===!0){if(t=l.p.savedRow.length>=1?0:null,null!==t){var o,d,s=e("td:eq("+r+")",l.rows[i]),a=l.p.colModel[r],n=a.name,c=e.jgrid.jqID(n);switch(a.edittype){case"select":if(a.editoptions.multiple){var p=e("#"+i+"_"+c,l.rows[i]),f=[];o=e(p).val(),o?o.join(","):o="",e("option:selected",p).each(function(i,r){f[i]=e(r).text()}),d=f.join(",")}else o=e("#"+i+"_"+c+" option:selected",l.rows[i]).val(),d=e("#"+i+"_"+c+" option:selected",l.rows[i]).text();a.formatter&&(d=o);break;case"checkbox":var u=["Yes","No"];a.editoptions&&(u=a.editoptions.value.split(":")),o=e("#"+i+"_"+c,l.rows[i]).is(":checked")?u[0]:u[1],d=o;break;case"password":case"text":case"textarea":case"button":o=e("#"+i+"_"+c,l.rows[i]).val(),d=o;break;case"custom":try{if(!a.editoptions||!e.isFunction(a.editoptions.custom_value))throw"e1";if(o=a.editoptions.custom_value.call(l,e(".customelement",s),"get"),void 0===o)throw"e2";d=o}catch(g){"e1"===g&&e.jgrid.info_dialog(e.jgrid.errors.errcap,"function 'custom_value' "+e.jgrid.edit.msg.nodefined,e.jgrid.edit.bClose),"e2"===g?e.jgrid.info_dialog(e.jgrid.errors.errcap,"function 'custom_value' "+e.jgrid.edit.msg.novalue,e.jgrid.edit.bClose):e.jgrid.info_dialog(e.jgrid.errors.errcap,g.message,e.jgrid.edit.bClose)}}if(d!==l.p.savedRow[t].v){var h=e(l).triggerHandler("jqGridBeforeSaveCell",[l.rows[i].id,n,o,i,r]);if(h&&(o=h,d=h),e.isFunction(l.p.beforeSaveCell)){var v=l.p.beforeSaveCell.call(l,l.rows[i].id,n,o,i,r);v&&(o=v,d=v)}var w=e.jgrid.checkValues.call(l,o,r);if(w[0]===!0){var C=e(l).triggerHandler("jqGridBeforeSubmitCell",[l.rows[i].id,n,o,i,r])||{};if(e.isFunction(l.p.beforeSubmitCell)&&(C=l.p.beforeSubmitCell.call(l,l.rows[i].id,n,o,i,r),C||(C={})),e("input.hasDatepicker",s).length>0&&e("input.hasDatepicker",s).datepicker("hide"),"remote"===l.p.cellsubmit)if(l.p.cellurl){var j={};l.p.autoencode&&(o=e.jgrid.htmlEncode(o)),j[n]=o;var b,m,q;q=l.p.prmNames,b=q.id,m=q.oper,j[b]=e.jgrid.stripPref(l.p.idPrefix,l.rows[i].id),j[m]=q.editoper,j=e.extend(C,j),e("#lui_"+e.jgrid.jqID(l.p.id)).show(),l.grid.hDiv.loading=!0,e.ajax(e.extend({url:l.p.cellurl,data:e.isFunction(l.p.serializeCellData)?l.p.serializeCellData.call(l,j):j,type:"POST",complete:function(t,a){if(e("#lui_"+l.p.id).hide(),l.grid.hDiv.loading=!1,"success"===a){var c=e(l).triggerHandler("jqGridAfterSubmitCell",[l,t,j.id,n,o,i,r])||[!0,""];c[0]===!0&&e.isFunction(l.p.afterSubmitCell)&&(c=l.p.afterSubmitCell.call(l,t,j.id,n,o,i,r)),c[0]===!0?(e(s).empty(),e(l).jqGrid("setCell",l.rows[i].id,r,d,!1,!1,!0),e(s).addClass("dirty-cell"),e(l.rows[i]).addClass("edited"),e(l).triggerHandler("jqGridAfterSaveCell",[l.rows[i].id,n,o,i,r]),e.isFunction(l.p.afterSaveCell)&&l.p.afterSaveCell.call(l,l.rows[i].id,n,o,i,r),l.p.savedRow.splice(0,1)):(e.jgrid.info_dialog(e.jgrid.errors.errcap,c[1],e.jgrid.edit.bClose),e(l).jqGrid("restoreCell",i,r))}},error:function(t,o,d){e("#lui_"+e.jgrid.jqID(l.p.id)).hide(),l.grid.hDiv.loading=!1,e(l).triggerHandler("jqGridErrorCell",[t,o,d]),e.isFunction(l.p.errorCell)?(l.p.errorCell.call(l,t,o,d),e(l).jqGrid("restoreCell",i,r)):(e.jgrid.info_dialog(e.jgrid.errors.errcap,t.status+" : "+t.statusText+"<br/>"+o,e.jgrid.edit.bClose),e(l).jqGrid("restoreCell",i,r))}},e.jgrid.ajaxOptions,l.p.ajaxCellOptions||{}))}else try{e.jgrid.info_dialog(e.jgrid.errors.errcap,e.jgrid.errors.nourl,e.jgrid.edit.bClose),e(l).jqGrid("restoreCell",i,r)}catch(g){}"clientArray"===l.p.cellsubmit&&(e(s).empty(),e(l).jqGrid("setCell",l.rows[i].id,r,d,!1,!1,!0),e(s).addClass("dirty-cell"),e(l.rows[i]).addClass("edited"),e(l).triggerHandler("jqGridAfterSaveCell",[l.rows[i].id,n,o,i,r]),e.isFunction(l.p.afterSaveCell)&&l.p.afterSaveCell.call(l,l.rows[i].id,n,o,i,r),l.p.savedRow.splice(0,1))}else try{window.setTimeout(function(){e.jgrid.info_dialog(e.jgrid.errors.errcap,o+" "+w[1],e.jgrid.edit.bClose)},100),e(l).jqGrid("restoreCell",i,r)}catch(g){}}else e(l).jqGrid("restoreCell",i,r)}window.setTimeout(function(){e("#"+e.jgrid.jqID(l.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(i,r){return this.each(function(){var t,l=this;if(l.grid&&l.p.cellEdit===!0){if(t=l.p.savedRow.length>=1?0:null,null!==t){var o=e("td:eq("+r+")",l.rows[i]);if(e.isFunction(e.fn.datepicker))try{e("input.hasDatepicker",o).datepicker("hide")}catch(d){}e(o).empty().attr("tabindex","-1"),e(l).jqGrid("setCell",l.rows[i].id,r,l.p.savedRow[t].v,!1,!1,!0),e(l).triggerHandler("jqGridAfterRestoreCell",[l.rows[i].id,l.p.savedRow[t].v,i,r]),e.isFunction(l.p.afterRestoreCell)&&l.p.afterRestoreCell.call(l,l.rows[i].id,l.p.savedRow[t].v,i,r),l.p.savedRow.splice(0,1)}window.setTimeout(function(){e("#"+l.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(i,r){return this.each(function(){var t,l=this,o=!1;if(l.grid&&l.p.cellEdit===!0){for(t=r+1;t<l.p.colModel.length;t++)if(l.p.colModel[t].editable===!0){o=t;break}o!==!1?e(l).jqGrid("editCell",i,o,!0):l.p.savedRow.length>0&&e(l).jqGrid("saveCell",i,r)}})},prevCell:function(i,r){return this.each(function(){var t,l=this,o=!1;if(l.grid&&l.p.cellEdit===!0){for(t=r-1;t>=0;t--)if(l.p.colModel[t].editable===!0){o=t;break}o!==!1?e(l).jqGrid("editCell",i,o,!0):l.p.savedRow.length>0&&e(l).jqGrid("saveCell",i,r)}})},GridNav:function(){return this.each(function(){function i(i,r,l){if("v"===l.substr(0,1)){var o=e(t.grid.bDiv)[0].clientHeight,d=e(t.grid.bDiv)[0].scrollTop,s=t.rows[i].offsetTop+t.rows[i].clientHeight,a=t.rows[i].offsetTop;"vd"===l&&s>=o&&(e(t.grid.bDiv)[0].scrollTop=e(t.grid.bDiv)[0].scrollTop+t.rows[i].clientHeight),"vu"===l&&d>a&&(e(t.grid.bDiv)[0].scrollTop=e(t.grid.bDiv)[0].scrollTop-t.rows[i].clientHeight)}if("h"===l){var n=e(t.grid.bDiv)[0].clientWidth,c=e(t.grid.bDiv)[0].scrollLeft,p=t.rows[i].cells[r].offsetLeft+t.rows[i].cells[r].clientWidth,f=t.rows[i].cells[r].offsetLeft;p>=n+parseInt(c,10)?e(t.grid.bDiv)[0].scrollLeft=e(t.grid.bDiv)[0].scrollLeft+t.rows[i].cells[r].clientWidth:c>f&&(e(t.grid.bDiv)[0].scrollLeft=e(t.grid.bDiv)[0].scrollLeft-t.rows[i].cells[r].clientWidth)}}function r(e,i){var r,l;if("lft"===i)for(r=e+1,l=e;l>=0;l--)if(t.p.colModel[l].hidden!==!0){r=l;break}if("rgt"===i)for(r=e-1,l=e;l<t.p.colModel.length;l++)if(t.p.colModel[l].hidden!==!0){r=l;break}return r}var t=this;if(t.grid&&t.p.cellEdit===!0){t.p.knv=t.p.id+"_kn";var l,o,d=e("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+t.p.knv+"'></div></div>");e(d).insertBefore(t.grid.cDiv),e("#"+t.p.knv).focus().keydown(function(d){switch(o=d.keyCode,"rtl"===t.p.direction&&(37===o?o=39:39===o&&(o=37)),o){case 38:t.p.iRow-1>0&&(i(t.p.iRow-1,t.p.iCol,"vu"),e(t).jqGrid("editCell",t.p.iRow-1,t.p.iCol,!1));break;case 40:t.p.iRow+1<=t.rows.length-1&&(i(t.p.iRow+1,t.p.iCol,"vd"),e(t).jqGrid("editCell",t.p.iRow+1,t.p.iCol,!1));break;case 37:t.p.iCol-1>=0&&(l=r(t.p.iCol-1,"lft"),i(t.p.iRow,l,"h"),e(t).jqGrid("editCell",t.p.iRow,l,!1));break;case 39:t.p.iCol+1<=t.p.colModel.length-1&&(l=r(t.p.iCol+1,"rgt"),i(t.p.iRow,l,"h"),e(t).jqGrid("editCell",t.p.iRow,l,!1));break;case 13:parseInt(t.p.iCol,10)>=0&&parseInt(t.p.iRow,10)>=0&&e(t).jqGrid("editCell",t.p.iRow,t.p.iCol,!0);break;default:return!0}return!1})}})},getChangedCells:function(i){var r=[];return i||(i="all"),this.each(function(){var t,l=this;l.grid&&l.p.cellEdit===!0&&e(l.rows).each(function(o){var d={};e(this).hasClass("edited")&&(e("td",this).each(function(r){if(t=l.p.colModel[r].name,"cb"!==t&&"subgrid"!==t)if("dirty"===i){if(e(this).hasClass("dirty-cell"))try{d[t]=e.unformat.call(l,this,{rowId:l.rows[o].id,colModel:l.p.colModel[r]},r)}catch(s){d[t]=e.jgrid.htmlDecode(e(this).html())}}else try{d[t]=e.unformat.call(l,this,{rowId:l.rows[o].id,colModel:l.p.colModel[r]},r)}catch(s){d[t]=e.jgrid.htmlDecode(e(this).html())}}),d.id=this.id,r.push(d))})}),r}})}(jQuery);